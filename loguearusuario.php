<?phprequire_once('datosaccesodb.php');require_once('GoogleAuthenticator.php');$errors         = array();  	// array para almacenar errores y validaciones$data 			= array(); 		// array para devolver datos//Conectamos con la DB$conexion = mysqli_connect($host, $usuario, $clave, $db);if (mysqli_connect_errno()) {	$errors['errordb'] = 'Fallo al intentar conectar con la base de datos';}else{	//Validaciones	if (empty($_POST['username'])){		$errors['username'] = 'Ingrese un usuario o correo';	}	$username = strstr($_POST['username'], '@', true);	if (!empty($username)) {		$email =  $_POST['username'];	}		if (empty($_POST['password'])){		$errors['password'] = 'Ingrese una clave';	}	if (empty($_POST['token'])){		$errors['token'] = 'Ingrese un token';	}		//Si no hay errores hasta ahora	if ( empty($errors)) {		//$username = $_POST["username"];		//echo $username;		if( empty($email)){			//echo "entreeeee";			//Compruebo que exista el usuario con esa contraseña en la DB			/* Preparo la consulta */			mysqli_query($conexion, "SET NAMES 'utf8'");			if( $consulta = mysqli_prepare($conexion, "SELECT id, nombre, usuario, email, secreto FROM usuarios WHERE usuario=? AND clave=?") ){				$hashclave = sha1($_POST['password']);				/* Preparo los parametros "?" s - string, b - blob, i - int, etc */				mysqli_stmt_bind_param($consulta, "ss", $_POST['username'], $hashclave);				/* La ejecuto */				if(!mysqli_stmt_execute($consulta)){					$errors['errordb'] = 'Fallo al intentar consultar la base de datos usuarios';				}				mysqli_stmt_store_result($consulta);								$filasdevueltas = mysqli_stmt_num_rows($consulta);												if($filasdevueltas < 1){					$errors['wronguserpass'] = 'Usuario o clave incorrectos.';				}else{					mysqli_stmt_bind_result($consulta, $valordevuelto0, $valordevuelto1, $valordevuelto2, $valordevuelto3, $valordevuelto4);					mysqli_stmt_fetch($consulta);										$id = $valordevuelto0;					$nombre = $valordevuelto1;					$usuario = $valordevuelto2;					$email = $valordevuelto3;					$secreto = $valordevuelto4;				}					/* Cierro consulta */				mysqli_stmt_close($consulta);			}else{				$errors['errordb'] = 'Fallo al intentar consultar la base de datos 1';			}		}else{						//Compruebo que exista el email con esa contraseña en la DB			/* Preparo la consulta */			mysqli_query($conexion, "SET NAMES 'utf8'");			if( $consulta = mysqli_prepare($conexion, "SELECT id, nombre, usuario, email, secreto FROM usuarios WHERE email=? AND clave=?") ){				$hashclave = sha1($_POST['password']);				/* Preparo los parametros "?" s - string, b - blob, i - int, etc */				mysqli_stmt_bind_param($consulta, "ss", $email, $hashclave);				/* La ejecuto */				if(!mysqli_stmt_execute($consulta)){					$errors['errordb'] = 'Fallo al intentar consultar la base de datos email';				}				mysqli_stmt_store_result($consulta);								$filasdevueltas = mysqli_stmt_num_rows($consulta);												if($filasdevueltas < 1){					$errors['wronguserpass'] = 'Email o clave incorrectos.';				}else{					mysqli_stmt_bind_result($consulta, $valordevuelto0, $valordevuelto1, $valordevuelto2, $valordevuelto3, $valordevuelto4);					mysqli_stmt_fetch($consulta);										$id = $valordevuelto0;					$nombre = $valordevuelto1;					$usuario = $valordevuelto2;					$email = $valordevuelto3;					$secreto = $valordevuelto4;				}				/* Cierro consulta */				mysqli_stmt_close($consulta);			}else{				$errors['errordb'] = 'Fallo al intentar consultar la base de datos 2';			}		}	}		mysqli_close($conexion);	}//Si no hay errores hasta ahoraif ( empty($errors)) {	/*Genero secreto para doble autenticacion*/	$ga = new PHPGangsta_GoogleAuthenticator();	$token = $_POST['token'];	$resultadoVerificacionToken = $ga->verifyCode($secreto, $token, 2);    // 2 = 2*30sec (toleracia de tiempo)	if (!$resultadoVerificacionToken) {		$errors['tokeninvalido'] = 'Token inválido o vencido';	}	}// Devolvemos una respuesta// Si hay erroresif ( !empty($errors)) {	$data['success'] = false;	$data['errors']  = $errors;} else {	// Si no hay errores		//Crea la sesión	session_start();	$_SESSION['idusuario'] = $id; // creamos en la sesion la variable "idusuario" y le asignamos como valor el id devuelto por la consulta	$_SESSION['nombre'] = $nombre; // creamos en la sesion la variable "nombre" y le asignamos como valor el nombre devuelto por la consulta	$_SESSION['usuario'] = $usuario; // creamos en la sesion la variable "usuario" y le asignamos como valor el usuario devuelto por la consulta	$_SESSION['email'] = $email; // creamos en la sesion la variable "email" y le asignamos como valor el email devuelto por la consulta		//Envía mensaje de retorno	$data['success'] = true;	$data['nombre'] = $nombre;	$data['message'] = 'Logueado con exito!';}// Enviamos los datos de respuestaecho json_encode($data);?>