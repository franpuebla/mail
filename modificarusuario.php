<?phprequire_once('datosaccesodbpostfix.php');$errors     = array();  	// array para almacenar errores y validaciones$data 			= array(); 		// array para devolver datos//Variables predefinidas$dominio = "franpuebla.com";//echo "ACAAAA";//Conectamos con la DB$conexion = mysqli_connect($host, $usuario, $clave, $db);if (mysqli_connect_errno()) {	$errors['errordb'] = 'Fallo al intentar conectar con la base de datos';}else{	//Validaciones	if (empty($_POST['username'])){		$errors['username'] = 'Falta ID a modificar';	}	if (empty($_POST['fullname'])){		$errors['fullname'] = 'Ingrese un nombre';	}	if (empty($_POST['email'])){		$errors['email'] = 'Ingrese un email';	}	/*	if (empty($_POST['password'])){		$errors['password'] = 'Ingrese una clave';	}	if (empty($_POST['rpassword'])){		$errors['rpassword'] = 'Ingrese un usuario';	}	*/	if (!empty($_POST['password']) AND !empty($_POST['rpassword'])){		if ($_POST['rpassword'] != $_POST['password']){			$errors['rpasswordmatch'] = 'Las claves no coinciden';		}	}	//Si no hay errores hasta ahora	if ( empty($errors)) {		//Compruebo que no haya alguien ya registrado con ese email		//Armamos el mail		$email = $_POST['email']."@".$dominio;		/* Preparo la consulta */		if( $consulta = mysqli_prepare($conexion, "SELECT * FROM mailbox WHERE username=? AND username!=?" )){			/* Preparo los parametros "?" s - string, b - blob, i - int, etc */			mysqli_stmt_bind_param($consulta, "ss", $email, $_POST['username']);			/* La ejecuto */			if(!mysqli_stmt_execute($consulta)){				$errors['errordb'] = 'Fallo al intentar consultar la base de datos';			}			mysqli_stmt_store_result($consulta);			$filasdevueltas = mysqli_stmt_num_rows($consulta);			if($filasdevueltas > 0){				$errors['emailexist'] = 'El email ingresado ya existe';			}			/* Cierro consulta */			mysqli_stmt_close($consulta);		}else{			$errors['errordb'] = 'Fallo al intentar consultar la base de datos';		}	}	//Si no hay errores hasta ahora y el campo clave está lleno	if ( empty($errors) AND !empty($_POST['password'])) {		/* Preparo la consulta */		if( $consulta = mysqli_prepare($conexion, "UPDATE mailbox SET password=? WHERE username=?") ){			$password = md5($_POST['password']);			$passwordmd5 = "{md5raw}".$password;			/* Preparo los parametros "?" s - string, b - blob, i - int, etc */			mysqli_stmt_bind_param($consulta, "ss", $passwordmd5, $_POST['username']);			/* La ejecuto */			if(!mysqli_stmt_execute($consulta)){				$errors['errordb'] = 'Fallo al intentar escribir en la base de datos';			}			/* Cierro consulta */			mysqli_stmt_close($consulta);		}else{			$errors['errordb'] = 'Fallo al intentar prepara consulta';		}	}	//Si no hay errores hasta ahora	if ( empty($errors)) {		//Modifico al usuario en la DB		/* Preparo la consulta */		if( $consulta = mysqli_prepare($conexion, "UPDATE mailbox SET name=?, maildir=?, username=?, active=? WHERE username=?") ){			$maildir = $dominio."/".$_POST['email']."/";			if ($_POST['activo'] == 'true'){				$bool1 = 1; //1 -> Activo | 0 -> Inactivo			}else{				$bool1 = 0; //1 -> Activo | 0 -> Inactivo			}			/* Preparo los parametros "?" s - string, b - blob, i - int, etc */			mysqli_stmt_bind_param($consulta, "sssis", $_POST['fullname'], $maildir, $email, $bool1, $_POST['username']);			/* La ejecuto */			if(!mysqli_stmt_execute($consulta)){				$errors['errordb'] = 'Fallo al intentar escribir en la base de datos';			}			/* Cierro consulta */			mysqli_stmt_close($consulta);			//ENVIAMOS MAIL DE BIENVENIDA (PARA CREAR ARBOL DE DIRECTORIOS DE MAILDIR)			$destinatario = $email;			$asunto = "Se ha modificado su cuenta!";			$cuerpo = '			<html>			<head>			   <title>Modificaciones</title>			</head>			<body>			<h1>Hola '.$_POST['fullname'].'!</h1>			<p>			<b>Le informamos que se han realizado modificaciones en su cuenta.</b>.			</p>			</body>			</html>			';			//para el envío en formato HTML			$headers = "MIME-Version: 1.0\r\n";			$headers .= "Content-type: text/html; charset=iso-8859-1\r\n";			//dirección del remitente			$headers .= "From: Sistema <info@franpuebla.com>\r\n";			mail($destinatario,$asunto,$cuerpo,$headers);		}else{			$errors['errordb'] = 'Fallo al intentar prepara consulta';		}	}	mysqli_close($conexion);}// Devolvemos una respuesta// Si hay erroresif ( !empty($errors)) {	$data['success'] = false;	$data['errors']  = $errors;} else {	// Si no hay errores	$data['success'] = true;	$data['message'] = 'Usuario modificado!';}// Enviamos los datos de respuestaecho json_encode($data);?>