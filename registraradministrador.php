<?phprequire_once('datosaccesodb.php');require_once('GoogleAuthenticator.php');$errors         = array();  	// array para almacenar errores y validaciones$data 			= array(); 		// array para devolver datos//Conectamos con la DB$conexion = mysqli_connect($host, $usuario, $clave, $db);if (mysqli_connect_errno()) {	$errors['errordb'] = 'Fallo al intentar conectar con la base de datos';}else{	//Validaciones	if (empty($_POST['fullname'])){		$errors['fullname'] = 'Ingrese un nombre';	}	if (empty($_POST['email'])){		$errors['email'] = 'Ingrese un email';	}	if (empty($_POST['username'])){		$errors['username'] = 'Ingrese un usuario';	}	if (empty($_POST['password'])){		$errors['password'] = 'Ingrese una clave';	}	if (empty($_POST['rpassword'])){		$errors['rpassword'] = 'Ingrese un usuario';	}	if (!empty($_POST['password']) AND !empty($_POST['rpassword'])){		if ($_POST['rpassword'] != $_POST['password']){			$errors['rpasswordmatch'] = 'Las claves no coinciden';		}	}	//Si no hay errores hasta ahora	if ( empty($errors)) {				//Compruebo que no haya alguien ya registrado con ese usuario		/* Preparo la consulta */		mysqli_query($conexion, "SET NAMES 'utf8'");		if( $consulta = mysqli_prepare($conexion, "SELECT * FROM usuarios WHERE usuario=?") ){			/* Preparo los parametros "?" s - string, b - blob, i - int, etc */			mysqli_stmt_bind_param($consulta, "s", $_POST['username']);			/* La ejecuto */			if(!mysqli_stmt_execute($consulta)){				$errors['errordb'] = 'Fallo al intentar consultar la base de datos';			}			mysqli_stmt_store_result($consulta);						$filasdevueltas = mysqli_stmt_num_rows($consulta);						if($filasdevueltas > 0){				$errors['usernameexist'] = 'El usuario ingresado ya existe';			}						/* Cierro consulta */			mysqli_stmt_close($consulta);		}else{			$errors['errordb'] = 'Fallo al intentar consultar la base de datos';		}				//Compruebo que no haya alguien ya registrado con ese email		/* Preparo la consulta */		if( $consulta = mysqli_prepare($conexion, "SELECT * FROM usuarios WHERE email=?") ){			/* Preparo los parametros "?" s - string, b - blob, i - int, etc */			mysqli_stmt_bind_param($consulta, "s", $_POST['email']);			/* La ejecuto */			if(!mysqli_stmt_execute($consulta)){				$errors['errordb'] = 'Fallo al intentar consultar la base de datos';			}			mysqli_stmt_store_result($consulta);						$filasdevueltas = mysqli_stmt_num_rows($consulta);						if($filasdevueltas > 0){				$errors['emailexist'] = 'El email ingresado ya existe';			}						/* Cierro consulta */			mysqli_stmt_close($consulta);		}else{			$errors['errordb'] = 'Fallo al intentar consultar la base de datos';		}	}	//Si no hay errores hasta ahora	if ( empty($errors)) {		//Ingreso al usuario en la DB		/* Preparo la consulta */		if( $consulta = mysqli_prepare($conexion, "INSERT INTO usuarios (nombre, email, usuario, clave, secreto, fecharegistro) VALUES (?, ?, ?, ?, ?, now())") ){			/*Genero secreto para doble autenticacion*/			$ga = new PHPGangsta_GoogleAuthenticator();			$secret = $ga->createSecret();			$qrCodeUrl = $ga->getQRCodeGoogleUrl('CRS', $secret);					$hashclave = sha1($_POST['password']);						/* Preparo los parametros "?" s - string, b - blob, i - int, etc */			mysqli_stmt_bind_param($consulta, "sssss", $_POST['fullname'], $_POST['email'], $_POST['username'], $hashclave, $secret);			/* La ejecuto */			if(!mysqli_stmt_execute($consulta)){				$errors['errordb'] = 'Fallo al intentar escribir en la base de datos';			}			/* Cierro consulta */			mysqli_stmt_close($consulta);		}else{			$errors['errordb'] = 'Fallo al intentar prepara consulta';		}	}	mysqli_close($conexion);	}// Devolvemos una respuesta// Si hay erroresif ( !empty($errors)) {	$data['success'] = false;	$data['errors']  = $errors;} else {	// Si no hay errores	$data['success'] = true;	$data['qr'] = $qrCodeUrl;	$data['secreto'] = $secret;	$data['message'] = 'Usuario Administrador registrado!';}// Enviamos los datos de respuestaecho json_encode($data);?>